---
import Layout from '../layouts/Layout.astro';
import ShowListItem from '../components/ShowListItem.astro';
import { getDeduplicatedShows, getDjColorClass, getRecordingsByKey } from '../lib/shows';

const deduped = getDeduplicatedShows();
const recordingsByKey = getRecordingsByKey();

// Collect unique DJ names (in order of appearance)
const djNames: string[] = [];
const djSeen = new Set<string>();
for (const entry of deduped) {
  if (!djSeen.has(entry.dj)) {
    djSeen.add(entry.dj);
    djNames.push(entry.dj);
  }
}

// Map DJ names to color classes (use first show for that DJ)
const djColorMap: Record<string, string> = {};
for (const entry of deduped) {
  if (!djColorMap[entry.dj]) {
    djColorMap[entry.dj] = getDjColorClass(entry.show);
  }
}
---

<Layout title="all shows | cabbage.town">
  <div class="shows-page">
    <nav class="shows-nav">
      <a class="shows-back" href="/">&larr; cabbage.town</a>
    </nav>

    <h2 class="shows-heading cooper">all shows</h2>

    <!-- DJ filter chips -->
    <div
      class="shows-filter"
      x-data={`{
        activeDj: '',
        init() {
          this.activeDj = new URLSearchParams(window.location.search).get('dj') || '';
        },
        setFilter(dj) {
          this.activeDj = dj;
          const url = new URL(window.location);
          if (dj) {
            url.searchParams.set('dj', dj);
          } else {
            url.searchParams.delete('dj');
          }
          history.replaceState({}, '', url);
        },
        matches(dj) {
          return !this.activeDj || this.activeDj === dj;
        }
      }`}
    >
      <div class="dj-chips">
        <button
          class="dj-chip"
          :class="{ 'dj-chip-active': !activeDj }"
          @click="setFilter('')"
        >all</button>
        {djNames.map((dj) => (
          <button
            class={`dj-chip ${djColorMap[dj] || ''}`}
            :class={`{ 'dj-chip-active': activeDj === '${dj.replace(/'/g, "\\'")}' }`}
            data-dj={dj}
            @click="setFilter($el.dataset.dj)"
          >{dj}</button>
        ))}
      </div>

      <div class="shows-card">
        <div class="show-list">
          {deduped.map((entry) => {
            const colorClass = getDjColorClass(entry.show);
            const rec = recordingsByKey.get(entry.keys[0]);
            return (
              <div
                data-dj={entry.dj}
                x-show="matches($el.dataset.dj)"
                x-cloak
              >
                <ShowListItem
                  displayName={entry.displayName}
                  colorClass={colorClass}
                  date={entry.date}
                  dj={entry.dj}
                  recUrl={rec?.url}
                  postSlug={entry.postSlug}
                />
              </div>
            );
          })}
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .shows-page {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 16px;
  }

  .shows-nav {
    width: 100%;
    max-width: 700px;
    padding: 16px 0;
  }

  .shows-back {
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    font-size: 0.85em;
  }

  .shows-back:hover {
    color: white;
    text-decoration: underline;
  }

  .shows-heading {
    color: white;
    font-size: 1.8em;
    width: 100%;
    max-width: 700px;
    margin-bottom: 16px;
  }

  .shows-filter {
    width: 100%;
    max-width: 700px;
  }

  .dj-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
    max-width: 700px;
    width: 100%;
  }

  .dj-chip {
    padding: 5px 12px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.8em;
    font-weight: bold;
    transition: all 0.15s;
  }

  .dj-chip:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
  }

  .dj-chip-active {
    background: white !important;
    color: #1a1a1a !important;
    border-color: white !important;
  }

  .shows-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    width: 100%;
    max-width: 700px;
    box-sizing: border-box;
  }

  .show-list {
    display: flex;
    flex-direction: column;
  }

  @media (max-width: 480px) {
    .shows-card {
      padding: 16px;
      border-radius: 16px;
    }
  }
</style>
