<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{if .Post}}Edit Post{{else}}New Post{{end}} - Cabbage Town</title>
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <style>
    .editor-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .editor-form {
      background: white;
      padding: 24px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1.1em;
      box-sizing: border-box;
    }

    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #2196F3;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
    }

    .editor-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .button {
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 1em;
      text-decoration: none;
      transition: all 0.2s ease;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .button.primary {
      background-color: #2196F3;
      color: white;
    }

    .button.primary:hover {
      background-color: #1976D2;
    }

    .button.success {
      background-color: #4CAF50;
      color: white;
    }

    .button.success:hover {
      background-color: #45a049;
    }

    .button.secondary {
      background-color: #9e9e9e;
      color: white;
    }

    .button.secondary:hover {
      background-color: #757575;
    }

    h2 {
      color: #2c3e50;
      margin: 0;
      font-size: 1.8em;
    }

    nav {
      background: #2c3e50;
      padding: 16px;
      margin-bottom: 32px;
    }

    nav a {
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background-color 0.2s;
      margin-right: 8px;
    }

    nav a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    body {
      background-color: #f5f6fa;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
    }

    .EasyMDEContainer {
      margin-bottom: 20px;
    }

    .EasyMDEContainer .CodeMirror {
      min-height: 400px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <nav>
    <a href="/files">Files</a>
    <a href="/posts">Posts</a>
    {{if .IsAdmin}}
    <a href="/admin/users">Users</a>
    {{end}}
    <a href="/logout">Logout</a>
  </nav>

  <div class="editor-container">
    <div class="editor-header">
      <h2>{{if .Post}}Edit Post{{else}}New Post{{end}}</h2>
      <a href="/posts" class="button secondary">Back to Posts</a>
    </div>

    <form class="editor-form" id="post-form">
      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" id="title" name="title" placeholder="Enter post title" required
          value="{{if .Post}}{{.Post.Title}}{{end}}">
      </div>

      <div class="form-group">
        <label for="author">Author</label>
        <input type="text" id="author" name="author" placeholder="Enter author name" required
          value="{{if .Post}}{{.Post.Author}}{{end}}">
      </div>

      <div class="form-group">
        <label for="recording">Related Recording (optional)</label>
        <select id="recording" name="recording">
          <option value="">No recording</option>
        </select>
        <small style="color: #666;">Link this post to a show recording</small>
      </div>

      <div class="form-group">
        <label for="markdown">Content</label>
        <textarea id="markdown" name="markdown">{{if .Post}}{{.Post.Markdown}}{{end}}</textarea>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="published" name="published" {{if .Post}}{{if .Post.Published}}checked{{end}}{{end}}>
          <label for="published">Published (visible to everyone)</label>
        </div>
      </div>

      <div class="editor-actions">
        <button type="button" class="button success" onclick="savePost()">Save Post</button>
        <a href="/posts" class="button secondary">Cancel</a>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    let postId = {{if .Post}}'{{.Post.ID}}'{{else}}null{{end}};
    const isEdit = postId !== null;
    const existingRecording = {{if .Post}}'{{.Post.Metadata.Recording}}'{{else}}''{{end}};

    // Load available recordings
    async function loadRecordings() {
      try {
        const response = await fetch('/api/recordings');
        if (!response.ok) {
          console.error('Failed to fetch recordings');
          return;
        }
        
        const recordings = await response.json();
        const select = document.getElementById('recording');
        
        // Sort by last modified (newest first)
        recordings.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
        
        // Add recordings to dropdown
        recordings.forEach(recording => {
          const option = document.createElement('option');
          option.value = recording.key;
          option.textContent = recording.displayName;
          select.appendChild(option);
        });
        
        // Select existing recording if editing
        if (existingRecording) {
          select.value = existingRecording;
        }
      } catch (error) {
        console.error('Error loading recordings:', error);
      }
    }

    // Load recordings when page loads
    loadRecordings();

    // Initialize EasyMDE
    const easyMDE = new EasyMDE({
      element: document.getElementById('markdown'),
      autosave: {
        enabled: true,
        uniqueId: isEdit ? 'post-edit-' + postId : 'post-new',
        delay: 1000,
      },
      spellChecker: false,
      placeholder: "Write your post content here...",
      toolbar: [
        "bold", "italic", "heading", "|",
        "quote", "unordered-list", "ordered-list", "|",
        "link", "upload-image", "|",
        "preview", "side-by-side", "fullscreen", "|",
        "guide"
      ],
      status: ["autosave", "lines", "words", "cursor"],
      uploadImage: true,
      imageUploadFunction: async function(file, onSuccess, onError) {
        // For new posts, we need to create a post first to get an ID
        let uploadPostId = postId;
        if (!uploadPostId) {
          const title = document.getElementById('title').value.trim();
          if (!title) {
            onError('Please enter a post title first');
            return;
          }
          
          const author = document.getElementById('author').value.trim();
          if (!author) {
            onError('Please enter an author name first');
            return;
          }
          
          // Get current markdown content to preserve it
          const currentMarkdown = easyMDE.value();
          const currentRecording = document.getElementById('recording').value;
          
          // Create a draft post with current content to get an ID (silently)
          const tempPost = await savePostAPI(title, author, currentMarkdown, false, currentRecording);
          if (!tempPost) {
            onError('Failed to create post');
            return;
          }
          
          // Update the postId for future uploads and update browser URL
          postId = tempPost.id;
          uploadPostId = tempPost.id;
          
          // Update URL without reload to reflect we're now editing
          window.history.replaceState({}, '', '/posts/' + postId + '/edit');
        }

        const formData = new FormData();
        formData.append('image', file);

        try {
          const response = await fetch('/api/posts/' + uploadPostId + '/images', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.url) {
            onSuccess(data.url);
          } else {
            onError('Failed to upload image');
          }
        } catch (error) {
          console.error('Error:', error);
          onError('Failed to upload image');
        }
      }
    });


    async function savePost() {
      const title = document.getElementById('title').value.trim();
      const author = document.getElementById('author').value.trim();
      const markdown = easyMDE.value();
      const published = document.getElementById('published').checked;
      const recording = document.getElementById('recording').value;

      if (!title) {
        alert('Please enter a post title');
        return;
      }

      if (!author) {
        alert('Please enter an author name');
        return;
      }

      const success = postId
        ? await updatePostAPI(postId, title, author, markdown, published, recording)
        : await savePostAPI(title, author, markdown, published, recording);

      if (success) {
        alert('Post saved successfully!');
        window.location.href = '/posts';
      } else {
        alert('Failed to save post');
      }
    }

    // Core API functions without UI side effects
    async function savePostAPI(title, author, markdown, published, recording) {
      try {
        const response = await fetch('/api/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: title,
            author: author,
            markdown: markdown,
            published: published,
            recording: recording
          })
        });

        const data = await response.json();
        return data.id ? data : null;
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    async function updatePostAPI(id, title, author, markdown, published, recording) {
      try {
        const response = await fetch('/api/posts/' + id, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: title,
            author: author,
            markdown: markdown,
            published: published,
            recording: recording
          })
        });

        const data = await response.json();
        return data.id ? data : null;
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }
  </script>
</body>

</html>