# CLAUDE.md — cabbage.town

Community radio station platform: website, backend CMS, and automation tools.

## Project structure

| Directory | What it is | Language | Entry point |
|---|---|---|---|
| `site/` | Public website (streaming, show archives) | TypeScript / Astro 5 + Alpine.js | `src/pages/` |
| `shed.cabbage.town/` | Backend server (posts, files, auth) | Go 1.23 | `cmd/server/main.go` |
| `scripts/trellis/` | Automation (recordings, playlists, metadata, ACLs) | Go 1.23 | `cmd/update_recordings/main.go` |

## Common commands

### Site (Astro frontend)

```sh
cd site
pnpm install        # install deps — always use pnpm, never npm/yarn
pnpm dev            # dev server on localhost:4321
pnpm build          # production build to dist/
```

### Shed (Go backend)

```sh
cd shed.cabbage.town
air                                    # live-reload dev server (uses .air.toml)
go build -o ./tmp/main ./cmd/server    # build binary
go run ./cmd/adduser                   # add a user
```

### Trellis (automation scripts)

```sh
cd scripts/trellis
go run ./cmd/update_recordings            # full workflow
go run ./cmd/update_recordings -dry-run   # test run
go run ./cmd/update_recordings acls       # ACLs only
go run ./cmd/update_recordings metadata   # metadata only
go run ./cmd/update_posts                 # export data to site's recordings.json
```

## Important: auto-generated files

- `site/src/data/recordings.json` — generated by trellis (`update_posts`), do NOT edit manually
- `site/public/` playlists and metadata — generated by trellis, do NOT edit manually

## Environment

- `.env.example` shows required vars (DigitalOcean Spaces credentials)
- Shed and Trellis both need `DO_ACCESS_KEY_ID` and `DO_SECRET_ACCESS_KEY`

## CI/CD

- **GitHub Pages**: Astro site auto-deploys on push to `main` (`.github/workflows/static.yml`)
- **Daily data sync**: Trellis runs daily at 5 UTC via GitHub Actions (`.github/workflows/update_recordings.yml`)

## Key patterns

- Alpine.js stores live in `site/src/entrypoint.ts` (audio player, DJ filters)
- Go packages use standard layout: `cmd/` for binaries, `pkg/` or `internal/` for libraries
- Gorilla mux for HTTP routing, Gorilla sessions for auth in shed
- S3-compatible API (DigitalOcean Spaces) via AWS SDK in trellis
- eyeD3 (Python) is used for ID3 tag processing in the recordings workflow
